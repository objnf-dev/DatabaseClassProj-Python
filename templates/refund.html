<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <title>车票管理系统 - 18271241</title>
    <!-- Bootstrap core CSS -->
    <link href="/static/bootstrap.min.css" rel="stylesheet" />
    <style>
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }
    </style>
    <!-- Custom styles for this template -->
    <link href="/static/starter-template.css" rel="stylesheet" />
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">车票管理系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsDefault"
                aria-controls="navbarsDefault" aria-expanded="false" aria-label="导航器"><span
                    class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarsDefault">
                <ul class="navbar-nav me-auto mb-2 mb-md-0">
                    <li class="nav-item active"><a class="nav-link" aria-current="page" href="/">查询</a></li>
                    <li class="nav-item"><a class="nav-link" href="/order" tabindex="-1">订票</a></li>
                    <li class="nav-item"><a class="nav-link" href="/refund" tabindex="-1">退票</a></li>
                    {% if session["is_admin"] %}
                    <li class="nav-item"><a class="nav-link" href="/admin" tabindex="-1">控制台</a></li>
                    {% endif %}
                </ul>
                <span class="navbar-text">
                    {% if session["is_admin"] %}
                    管理员
                    {% else %}
                    用户
                    {% endif %}
                    {{ session["user"] }}
                    &nbsp;&nbsp;
                </span>
                <button class="btn btn-outline-success" onclick="(function() { window.location.href = '/logout';})();">
                    退出登录
                </button>
            </div>
        </div>
    </nav>
    <main class="container">
        <!--Toast-->
        <div class="toast-container position-absolute top-10 end-0 p-3">
            <div id="failedToast" class="toast d-flex align-items-center text-white bg-danger border-0" role="alert"
                aria-atomic="true">
                <div class="toast-body">
                    所有值不能为空。
                </div>
                <button type="button" class="btn-close btn-close-white ms-auto me-2" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
            <div id="errorToast" class="toast d-flex align-items-center text-white bg-danger border-0" role="alert"
                aria-atomic="true">
                <div class="toast-body">
                    查询出错，请重试。
                </div>
                <button type="button" class="btn-close btn-close-white ms-auto me-2" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
            <div id="successToast" class="toast d-flex align-items-center text-white bg-danger border-0" role="alert"
                aria-atomic="true">
                <div class="toast-body">
                    查询并删除成功
                </div>
                <button type="button" class="btn-close btn-close-white ms-auto me-2" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">车次</th>
                    <th scope="col">始发站</th>
                    <th scope="col">始发时间</th>
                    <th scope="col">终点站</th>
                    <th scope="col">到达时间</th>
                    <th scope="col">票价</th>
                    <th scope="col">余量</th>
                </tr>
            </thead>
            <tbody id="queryRes">

            </tbody>
        </table>
        <div class="col-md-4">
            需要删除的车次
            <input id="train_name" type="text" class="form-control" placeholder="G1234">
        </div>
        <button type="button" onclick="refund()" class="btn btn-primary col-md-1">删除</button>
    </main>


</body>
<script src="/static/bootstrap.bundle.min.js">
    var runQuery = function runQuery() {
        let username = session["user"];


        let formData = new URLSearchParams();
        formData.append("username", username);


        window.fetch("/query", {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: formData
        }).then(function (res) {
            if (!res.ok) {
                let toast = new bootstrap.Toast(document.getElementById("errorToast"));
                toast.show();
                return ""
            }
            else {
                return res.text()
            }
        }).then(function (data) {
            if (data) {
                let table = document.getElementById("queryRes");
                table.innerHTML = data;
            }
        });



    }
    function refund() {
        let train_name = document.getElementById("train_name").value;
        let username = session["user"];

        let formData = new URLSearchParams();
        formData.append("train_name", train_name);
        formData.append("username", username);

        window.fetch("/refund", {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: formData
        }).then(function (res) {
            if (!res.ok) {
                let toast = new bootstrap.Toast(document.getElementById("errorToast"));
                toast.show();
                return ""
            }
            else {
                let toast = new bootstrap.Toast(document.getElementById("successToast"));
                toast.show();
                return ""
            }
        }).then(setTimeout(function () { window.location.href = "/refund" }, 2000));
    }


</script>

</html>